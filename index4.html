<!DOCTYPE html>
<html>
<body style="background: #121212; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 20px;">
    <nav>
    <a href="index.html" >Index</a>
    </nav>
    <h2 style="color: #00ffcc;">JS Physical Modeling Synth</h2>
    <canvas id="canvas" width="800" height="250" style="border: 2px solid #333; border-radius: 8px; background: #000; cursor: crosshair;"></canvas>
    
    <div style="display: flex; justify-content: center; gap: 30px; margin-top: 20px; flex-wrap: wrap;">
        <div>
            <label>Tension (Pitch)</label><br>
            <input type="range" id="tensionSlider" min="0.05" max="0.8" step="0.01" value="0.4">
        </div>
        <div>
            <label>Material Preset</label><br>
            <select id="materialPreset" style="background: #333; color: white; border: 1px solid #555; padding: 5px;">
                <option value="steel">Electric Steel (Bright)</option>
                <option value="nylon">Nylon (Warm)</option>
                <option value="palm">Palm Muted (Thud)</option>
            </select>
        </div>
        <div>
            <label>Pickup Position</label><br>
            <input type="range" id="pickupSlider" min="1" max="99" step="1" value="50">
        </div>
    </div>

    <button id="startBtn" style="margin-top: 30px; padding: 15px 40px; font-size: 1.1em; background: #00ffcc; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: #121212;">PLUCK STRING</button>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    // Simulation Constants
    const N = 80; 
    let u = new Float32Array(N);
    let u_prev = new Float32Array(N);
    let u_next = new Float32Array(N);
    
    let audioCtx, scriptNode;
    let isRunning = false;

    // Dynamic Parameters
    let currentTension = 0.4;
    let damping = 0.9997;
    let filterWeight = 0.05;
    let pickupIndex = Math.floor(N / 2);

    const presets = {
        steel: { damping: 0.9998, filter: 0.02 },
        nylon: { damping: 0.9992, filter: 0.45 },
        palm:  { damping: 0.9920, filter: 0.80 }
    };

    function pluck() {
        const pluckPoint = Math.floor(N * 0.3);
        for(let i = 1; i < N-1; i++) {
            // Create a sharp pluck shape
            const dist = Math.abs(i - pluckPoint);
            u[i] = Math.max(0, 1 - dist/10) * 0.6;
            u_prev[i] = u[i];
        }
    }

    function initAudio() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        scriptNode = audioCtx.createScriptProcessor(1024, 0, 1);

        scriptNode.onaudioprocess = (audioEvent) => {
            const output = audioEvent.outputBuffer.getChannelData(0);

            for (let s = 0; s < output.length; s++) {
                for (let i = 1; i < N - 1; i++) {
                    // Physics with damping
                    u_next[i] = (2 * u[i] - u_prev[i] + currentTension * (u[i+1] - 2*u[i] + u[i-1])) * damping;
                    
                    // Low-pass reflection filter (The "Material" logic)
                    u_next[i] = u_next[i] * (1 - filterWeight) + 
                                ((u_next[i-1] + u_next[i+1]) / 2) * filterWeight;
                }
                u_prev.set(u);
                u.set(u_next);
                output[s] = u[pickupIndex]; 
            }
        };
        scriptNode.connect(audioCtx.destination);
    }

    // UI Listeners
    document.getElementById('tensionSlider').oninput = (e) => currentTension = parseFloat(e.target.value);
    document.getElementById('pickupSlider').oninput = (e) => pickupIndex = Math.floor((e.target.value / 100) * (N-1));
    document.getElementById('materialPreset').onchange = (e) => {
        const p = presets[e.target.value];
        damping = p.damping;
        filterWeight = p.filter;
    };

    function draw() {
        ctx.fillStyle = 'rgba(0,0,0,0.3)'; // Motion blur effect
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Draw Pickup Marker
        ctx.fillStyle = '#444';
        ctx.fillRect((pickupIndex/(N-1))*canvas.width - 2, 0, 4, canvas.height);

        ctx.beginPath();
        ctx.strokeStyle = '#00ffcc';
        ctx.lineWidth = 3;
        for(let i=0; i<N; i++) {
            const x = (i / (N-1)) * canvas.width;
            const y = 125 + u[i] * 400;
            if(i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        }
        ctx.stroke();
        requestAnimationFrame(draw);
    }

    document.getElementById('startBtn').onclick = () => {
        if (!isRunning) { initAudio(); isRunning = true; }
        pluck();
    };

    draw();
</script>
</body>
</html>