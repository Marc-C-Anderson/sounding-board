<!DOCTYPE html>
<html>

<body>
    <nav>
        <a href="index.html">Index</a>
    </nav>
    <h1>1D Finite Difference Time Domain Simulation</h1>
    <p style="color: #ccc; font-family: sans-serif;">Click and drag to pluck the string.</p>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        // --- Audio Physics Setup ---
        const sampleRate = audioCtx.sampleRate;
        const stringLength = 100;
        // Global buffers for Audio FDTD to prevent re-allocation
        const audioPrev = new Float32Array(stringLength);
        const audioCurr = new Float32Array(stringLength);
        const audioNext = new Float32Array(stringLength);

        function playFDTDPluck(normalizedX) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const duration = 1.5;
            const buffer = audioCtx.createBuffer(1, sampleRate * duration, sampleRate);
            const output = buffer.getChannelData(0);
            // Reset Audio State
            audioPrev.fill(0);
            audioCurr.fill(0);
            audioNext.fill(0);
            // 1. Initial State (Triangle Pluck)
            const pluckIdx = Math.max(1, Math.min(stringLength - 2, Math.floor(normalizedX * stringLength)));
            for (let i = 0; i < stringLength; i++) {
                if (i < pluckIdx) audioCurr[i] = i / pluckIdx;
                else audioCurr[i] = (stringLength - i) / (stringLength - pluckIdx);
            }
            // 2. Simulation Constants
            const lambdaSq = 0.4; // Stability (must be < 1)
            const damping = 0.99995; // Audio sustain
            const pickupPosition = Math.floor(stringLength * 0.15);
            // 3. Generate Audio Buffer
            for (let t = 0; t < output.length; t++) {
                for (let i = 1; i < stringLength - 1; i++) {
                    audioNext[i] = (2 * audioCurr[i] - audioPrev[i] + lambdaSq * (audioCurr[i + 1] - 2 * audioCurr[i] + audioCurr[i - 1])) * damping;
                }
                output[t] = audioNext[pickupPosition]; // Pickup position
                audioPrev.set(audioCurr);
                audioCurr.set(audioNext);
            }
            // 4. Playback
            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            const gainNode = audioCtx.createGain();
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            source.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            source.start();
        }
        const normX = 0.2;
        playFDTDPluck(normX);
    </script>
</body>

</html>