<!DOCTYPE html>
<html>
<body style="background: #1a1a1a; color: #ff9900; font-family: 'Courier New', monospace; text-align: center; padding: 20px;">
    <nav>
    <a href="index.html" >Index</a>
    </nav>
    <h2 style="text-shadow: 2px 2px #000;">ROCK BOX: 6-String Physical Synth</h2>
    <canvas id="canvas" width="800" height="250" style="border: 4px solid #333; border-radius: 10px; background: #050505;"></canvas>
    
    <div style="background: #222; padding: 20px; border-radius: 10px; display: inline-block; margin-top: 20px; border: 1px solid #444;">
        <div style="display: flex; gap: 20px;">
            <div><label>DRIVE</label><br><input type="range" id="drive" min="1" max="20" value="5"></div>
            <div><label>TONE</label><br><input type="range" id="tone" min="0.05" max="0.9" step="0.05" value="0.3"></div>
            <div><label>REVERB</label><br><input type="range" id="reverb" min="0" max="0.8" step="0.1" value="0.3"></div>
        </div>
        <p style="font-size: 0.8em; color: #888; margin-top: 15px;">KEYS [1-6] to Pluck | [Q-Y] to Fret</p>
    </div>
    <br>
    <button id="startBtn" style="margin-top: 20px; padding: 15px 40px; background: #ff9900; border: none; font-weight: bold; cursor: pointer; border-radius: 5px;">ENGAGE AMP</button>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const N = 80;
    const tensions = [0.15, 0.22, 0.30, 0.42, 0.55, 0.75]; 
    
    class GuitarString {
        constructor(tension) {
            this.u = new Float32Array(N); this.u_prev = new Float32Array(N); this.u_next = new Float32Array(N);
            this.tension = tension; this.fret = 0; this.damping = 0.9995;
        }
        pluck() {
            const start = Math.floor((1 - (1 / Math.pow(2, this.fret / 12))) * (N - 5));
            const mid = (N + start) / 2;
            for(let i = start + 1; i < N - 1; i++) {
                this.u[i] = (1 - Math.abs(i - mid) / ((N - start) / 2)) * 0.4;
                this.u_prev[i] = this.u[i];
            }
        }
        update() {
            const activeStart = Math.floor((1 - (1 / Math.pow(2, this.fret / 12))) * (N - 5));
            for (let i = 0; i <= activeStart; i++) { this.u[i] = 0; this.u_prev[i] = 0; }
            for (let i = activeStart + 1; i < N - 1; i++) {
                this.u_next[i] = (2 * this.u[i] - this.u_prev[i] + this.tension * (this.u[i+1] - 2*this.u[i] + this.u[i-1])) * this.damping;
            }
            this.u_prev.set(this.u); this.u.set(this.u_next);
            return this.u[N - 8];
        }
    }

    const guitar = tensions.map(t => new GuitarString(t));
    let audioCtx, isRunning = false;
    let delayBuffer = new Float32Array(8000), dIdx = 0, lastOut = 0;

    function initAudio() {
        audioCtx = new AudioContext();
        const node = audioCtx.createScriptProcessor(1024, 0, 1);
        node.onaudioprocess = (e) => {
            const out = e.outputBuffer.getChannelData(0);
            const driveVal = parseFloat(document.getElementById('drive').value);
            const toneVal = parseFloat(document.getElementById('tone').value);
            const revVal = parseFloat(document.getElementById('reverb').value);

            for (let s = 0; s < out.length; s++) {
                let sum = 0;
                for (let i = 0; i < 6; i++) sum += guitar[i].update();

                // 1. Distortion (Soft Clipping)
                let sig = Math.tanh(sum * driveVal);

                // 2. Reverb (Feedback Delay)
                let echo = delayBuffer[dIdx];
                delayBuffer[dIdx] = sig + echo * 0.4;
                dIdx = (dIdx + 1) % delayBuffer.length;
                sig = (sig * (1 - revVal)) + (echo * revVal);

                // 3. Tone Filter (Low Pass)
                sig = lastOut + toneVal * (sig - lastOut);
                lastOut = sig;

                out[s] = sig * 0.6;
            }
        };
        node.connect(audioCtx.destination);
    }

    window.addEventListener('keydown', (e) => {
        const sIdx = parseInt(e.key) - 1;
        if (sIdx >= 0 && sIdx < 6) guitar[sIdx].pluck();
        const fretMap = {'q':1,'w':2,'e':3,'r':4,'t':5,'y':7,'u':9};
        if (fretMap[e.key]) guitar.forEach(s => s.fret = fretMap[e.key]);
    });

    function draw() {
        ctx.fillStyle = 'rgba(0,0,0,0.15)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        guitar.forEach((s, idx) => {
            ctx.beginPath(); ctx.strokeStyle = `hsl(${idx * 30 + 20}, 100%, 50%)`;
            const rowY = 40 + (idx * 35);
            for(let i=0; i<N; i++) ctx.lineTo((i/(N-1))*canvas.width, rowY + s.u[i]*400);
            ctx.stroke();
        });
        requestAnimationFrame(draw);
    }

    document.getElementById('startBtn').onclick = () => { if(!isRunning){ initAudio(); isRunning=true; } draw(); };
</script>
</body>
</html>